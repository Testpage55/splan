<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S√§kerhetsplan - Troja Ljungby</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Troja Ljungby Official Colors (Red, Yellow, White, Black) -->
    <!-- Application Structure Plan: En enkelsidig applikation (SPA) med en fast sidomeny f√∂r navigering mellan huvudsektioner: √ñversikt, Riskanalys, Organisation, √Ötg√§rdsplaner, Rutiner och en ny sektion f√∂r Scenario√∂vning. Denna struktur valdes f√∂r att ge snabb och intuitiv √•tkomst till specifik information, vilket √§r avg√∂rande i b√•de planerings- och akutfaser. Interaktiva element som klickbara kort och ett dynamiskt diagram anv√§nds f√∂r att presentera komplex information p√• ett l√§tt√∂versk√•dligt s√§tt, vilket fr√§mjar f√∂rst√•else och snabba beslut. -->
    <!-- Visualization & Content Choices:
        - Riskanalys: Ett interaktivt bubbeldiagram (Chart.js) f√∂r att visualisera riskernas allvarlighetsgrad.
        - Organisation: Ett organisationsschema byggt med HTML/CSS (Flexbox) och klickbara kort.
        - √Ötg√§rdsplaner: Ett rutn√§t av ikonbaserade kort (HTML/Tailwind).
        - Rutiner: Tidslinje och checklistor (HTML/CSS).
        - Scenario√∂vning: En ny funktion driven av Gemini API f√∂r att generera anpassade s√§kerhetsscenarier.
        - Fr√•ga S√§kerhets-AI: En ny chatbotfunktion driven av Gemini API f√∂r att svara p√• fr√•gor om planen.
        Samtliga val √§r gjorda f√∂r att maximera anv√§ndarv√§nlighet och informations√•tkomst utan att anv√§nda SVG eller Mermaid. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #880000 0%, #bb0000 100%); /* Red gradient */
            color: #f8fafc; /* For better contrast on dark background */
        }
        .text-slate-800 {
            color: #f8fafc;
        }
        .text-slate-600 {
            color: #e2e8f0;
        }
        .text-slate-500 {
            color: #cbd5e1;
        }
        .bg-slate-100 {
            background-color: transparent;
        }
        .bg-white {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-color: rgba(255, 255, 255, 0.2);
            color: #1e293b; /* Dark text for readability */
        }
        .bg-white h3, .bg-white p {
            color: inherit;
        }
        .bg-white.role-card h3, .bg-white.role-card p {
             color: inherit;
        }
        .main-content {
            transition: all 0.3s ease-in-out;
        }
        .nav-link {
            transition: all 0.2s;
        }
        .nav-link.active {
            background-color: #FFD700; /* Yellow */
            color: #880000;
            font-weight: 600;
        }
        .nav-link:not(.active):hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
            background-color: rgba(255, 255, 255, 0.9);
            color: #1e293b;
        }
        .modal-content .border-b {
            border-bottom-color: rgba(30, 41, 59, 0.2);
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 50vh;
        }
         .role-card {
            background-color: #8B0000; /* Dark Red */
            border-color: rgba(255, 255, 255, 0.2);
            color: white; /* Keep text white on these cards */
        }
        .role-card h3, .role-card p {
            color: inherit;
        }
        .bg-white.role-card h3, .bg-white.role-card p {
             color: white;
        }
         .role-card:hover {
            background-color: rgba(139, 0, 0, 0.8);
        }
        .action-card {
            background-color: #8B0000; /* Dark Red */
            color: white;
        }
        .action-card:hover {
            background-color: rgba(139, 0, 0, 0.8);
        }
        .generator-box {
            background-color: #8B0000; /* Dark Red */
            color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }
        .generator-box h3 {
            color: #FFD700; /* Yellow */
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        .chat-message {
            max-width: 85%;
            padding: 0.75rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #FFD700; /* Yellow */
            color: #880000;
            align-self: flex-end;
            border-bottom-right-radius: 0;
        }
        .ai-message {
            background-color: #1e293b; /* Dark Slate Blue */
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 0;
        }
    </style>
</head>
<body class="text-white">

    <div class="flex h-screen">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-transparent shadow-md flex-shrink-0 backdrop-blur-md bg-black bg-opacity-20">
            <div class="p-6 border-b border-red-800">
                <img src="https://troja-ljungby.com/wp-content/uploads/2021/08/trojalogga_2021_svart.png" alt="Troja Ljungby Logotyp" class="w-32 mx-auto mb-2 filter invert brightness-200">
                <h1 class="text-2xl font-bold text-white">Troja Ljungby</h1>
                <p class="text-sm text-red-100">S√§kerhetsplan</p>
            </div>
            <nav id="main-nav" class="p-4 space-y-2">
                <a href="#oversikt" class="nav-link flex items-center p-3 rounded-lg active">
                    <span class="mr-3">üìä</span> √ñversikt
                </a>
                <a href="#riskanalys" class="nav-link flex items-center p-3 rounded-lg">
                    <span class="mr-3">üî¨</span> Riskanalys
                </a>
                <a href="#organisation" class="nav-link flex items-center p-3 rounded-lg">
                    <span class="mr-3">üë•</span> Organisation & Roller
                </a>
                <a href="#atgardsplaner" class="nav-link flex items-center p-3 rounded-lg">
                    <span class="mr-3">üìã</span> √Ötg√§rdsplaner
                </a>
                <a href="#rutiner" class="nav-link flex items-center p-3 rounded-lg">
                    <span class="mr-3">üîÑ</span> Rutiner & Utbildning
                </a>
                <a href="#arena" class="nav-link flex items-center p-3 rounded-lg">
                    <span class="mr-3">üèüÔ∏è</span> Ljungby Arena
                </a>
                <a href="#scenario" class="nav-link flex items-center p-3 rounded-lg">
                    <span class="mr-3">üí°</span> Scenario√∂vning
                </a>
                <a href="#rapport" class="nav-link flex items-center p-3 rounded-lg">
                    <span class="mr-3">üìù</span> H√§ndelserapport
                </a>
                <a href="#chatbot" class="nav-link flex items-center p-3 rounded-lg">
                    <span class="mr-3">ü§ñ</span> Fr√•ga S√§kerhets-AI ‚ú®
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <div id="content-container" class="p-6 md:p-10">

                <!-- √ñversikt Section -->
                <section id="oversikt" class="main-content">
                    <h2 class="text-3xl font-bold mb-2">√ñversiktlig S√§kerhetsplan</h2>
                    <p class="text-red-100 mb-6">Denna plan syftar till att f√∂rebygga, hantera och minimera risker i samband med Troja Ljungbys evenemang. M√•let √§r att garantera s√§kerheten f√∂r alla inblandade: spelare, funktion√§rer, publik och personal, i enlighet med MSB:s och Svenska Ishockeyf√∂rbundets riktlinjer.</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <h3 class="font-semibold text-lg mb-2 text-red-600">Syfte</h3>
                            <p class="text-gray-700">Att skapa en trygg och s√§ker milj√∂ d√§r ishockeyn st√•r i centrum, fri fr√•n v√•ld, hot och ordningsst√∂rningar.</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <h3 class="font-semibold text-lg mb-2 text-red-600">Ansvar</h3>
                            <p class="text-gray-700">En utsedd s√§kerhetsansvarig har det √∂vergripande ansvaret f√∂r planering, genomf√∂rande och uppf√∂ljning av s√§kerhetsarbetet.</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <h3 class="font-semibold text-lg mb-2 text-red-600">Grundprinciper</h3>
                            <p class="text-gray-700">Proaktivitet, tydlig ansvarsf√∂rdelning, samverkan med myndigheter och kontinuerlig utv√§rdering √§r grundpelarna i v√•rt arbete.</p>
                        </div>
                    </div>
                </section>

                <!-- Riskanalys Section -->
                <section id="riskanalys" class="main-content hidden">
                    <h2 class="text-3xl font-bold mb-2">Interaktiv Riskanalys</h2>
                    <p class="text-red-100 mb-6">H√§r visualiseras och detaljeras de identifierade riskerna. Diagrammet visar riskernas relativa allvarlighetsgrad baserat p√• sannolikhet och konsekvens. Klicka p√• en riskkategori f√∂r att se specifika hot och f√∂rebyggande √•tg√§rder.</p>

                    <div class="bg-white p-6 rounded-xl shadow-sm border mb-6">
                        <div class="chart-container">
                            <canvas id="riskChart"></canvas>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div id="risk-filters" class="flex flex-wrap gap-2">
                             <button class="risk-filter-btn bg-[#FFD700] text-[#880000] py-2 px-4 rounded-lg shadow-sm" data-risk="all">Alla Risker</button>
                             <button class="risk-filter-btn bg-white text-gray-700 py-2 px-4 rounded-lg shadow-sm border" data-risk="publik">Publikrelaterat</button>
                             <button class="risk-filter-btn bg-white text-gray-700 py-2 px-4 rounded-lg shadow-sm border" data-risk="arena">Arenarelaterat</button>
                             <button class="risk-filter-btn bg-white text-gray-700 py-2 px-4 rounded-lg shadow-sm border" data-risk="spel">Spelrelaterat</button>
                        </div>
                    </div>

                    <div id="risk-details" class="space-y-4"></div>
                </section>

                <!-- Organisation Section -->
                <section id="organisation" class="main-content hidden">
                    <h2 class="text-3xl font-bold mb-2">S√§kerhetsorganisation & Roller</h2>
                    <p class="text-red-100 mb-6">En tydlig och v√§lfungerande organisation √§r nyckeln till ett framg√•ngsrikt s√§kerhetsarbete. Nedan visas ansvarskedjan och de centrala rollerna. Klicka p√• en roll f√∂r att se detaljerade ansvarsomr√•den.</p>

                    <div class="bg-white p-8 rounded-xl shadow-sm border text-center">
                        <div class="inline-block bg-[#8B0000] text-white p-4 rounded-lg shadow-lg cursor-pointer role-card" data-role="sakerhetsansvarig">
                            <h3 class="font-bold text-lg">S√§kerhetsansvarig</h3>
                            <p class="text-sm">√ñvergripande Ledning</p>
                        </div>
                        <div class="w-px bg-red-400 h-12 mx-auto"></div>
                        <div class="flex justify-center gap-4 md:gap-8 flex-wrap">
                             <div class="inline-block bg-[#8B0000] text-white p-4 rounded-lg shadow-sm cursor-pointer role-card" data-role="ordningsvakter">
                                <h3 class="font-semibold text-white">Ordningsvakter</h3>
                                <p class="text-white text-sm">Publikkontroll</p>
                            </div>
                            <div class="inline-block bg-[#8B0000] text-white p-4 rounded-lg shadow-sm cursor-pointer role-card" data-role="sjukvard">
                                <h3 class="font-semibold text-white">Sjukv√•rdsansvarig</h3>
                                <p class="text-white text-sm">Medicinsk Beredskap</p>
                            </div>
                            <div class="inline-block bg-[#8B0000] text-white p-4 rounded-lg shadow-sm cursor-pointer role-card" data-role="brandskydd">
                                <h3 class="font-semibold text-white">Brandskyddsansvarig</h3>
                                <p class="text-white text-sm">Brand & Utrymning</p>
                            </div>
                            <div class="inline-block bg-[#8B0000] text-white p-4 rounded-lg shadow-sm cursor-pointer role-card" data-role="publikvardar">
                                <h3 class="font-semibold text-white">Publikv√§rdar</h3>
                                <p class="text-white text-sm">Service & Information</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- √Ötg√§rdsplaner Section -->
                <section id="atgardsplaner" class="main-content hidden">
                     <h2 class="text-3xl font-bold mb-2">√Ötg√§rdsplaner vid Incident</h2>
                    <p class="text-red-100 mb-6">F√∂rberedda planer f√∂r specifika h√§ndelser √§r avg√∂rande f√∂r att agera snabbt, korrekt och samordnat. Klicka p√• en incidenttyp f√∂r att se den rekommenderade √•tg√§rdskedjan.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-[#8B0000] p-6 rounded-xl shadow-sm border hover:shadow-lg hover:-translate-y-1 transition-all cursor-pointer action-card" data-action="brand">
                            <div class="text-4xl mb-3">üî•</div>
                            <h3 class="font-semibold text-xl mb-1 text-[#FFD700]">Brand eller R√∂kutveckling</h3>
                            <p class="text-white">Plan f√∂r larm, utrymning och f√∂rsta insats.</p>
                        </div>
                        <div class="bg-[#8B0000] p-6 rounded-xl shadow-sm border hover:shadow-lg hover:-translate-y-1 transition-all cursor-pointer action-card" data-action="sjukdom">
                            <div class="text-4xl mb-3">‚öïÔ∏è</div>
                            <h3 class="font-semibold text-xl mb-1 text-[#FFD700]">Akut Sjukdomsfall/Skada</h3>
                            <p class="text-white">Rutiner f√∂r f√∂rsta hj√§lpen och larm till 112.</p>
                        </div>
                        <div class="bg-[#8B0000] p-6 rounded-xl shadow-sm border hover:shadow-lg hover:-translate-y-1 transition-all cursor-pointer action-card" data-action="ordningsstorning">
                             <div class="text-4xl mb-3">üó£Ô∏è</div>
                            <h3 class="font-semibold text-xl mb-1 text-[#FFD700]">Ordningsst√∂rning</h3>
                            <p class="text-white">Hantering av br√•k, berusning och otill√•tet beteende.</p>
                        </div>
                         <div class="bg-[#8B0000] p-6 rounded-xl shadow-sm border hover:shadow-lg hover:-translate-y-1 transition-all cursor-pointer action-card" data-action="utrymning">
                             <div class="text-4xl mb-3">üèÉ</div>
                            <h3 class="font-semibold text-xl mb-1 text-[#FFD700]">Utrymning</h3>
                            <p class="text-white">Generell plan f√∂r evakuering av arenan.</p>
                        </div>
                        <div class="bg-[#8B0000] p-6 rounded-xl shadow-sm border hover:shadow-lg hover:-translate-y-1 transition-all cursor-pointer action-card" data-action="hot">
                            <div class="text-4xl mb-3">üí£</div>
                            <h3 class="font-semibold text-xl mb-1 text-[#FFD700]">Allvarligt Hot</h3>
                            <p class="text-white">Protokoll f√∂r bombhot eller annat allvarligt hot.</p>
                        </div>
                         <div class="bg-[#8B0000] p-6 rounded-xl shadow-sm border hover:shadow-lg hover:-translate-y-1 transition-all cursor-pointer action-card" data-action="pyroteknik">
                            <div class="text-4xl mb-3">üß®</div>
                            <h3 class="font-semibold text-xl mb-1 text-[#FFD700]">Pyroteknik</h3>
                            <p class="text-white">Rutiner vid anv√§ndning av otill√•ten pyroteknik.</p>
                        </div>
                    </div>
                </section>

                 <!-- Rutiner & Utbildning Section -->
                <section id="rutiner" class="main-content hidden">
                    <h2 class="text-3xl font-bold mb-2">Rutiner & Utbildning</h2>
                    <p class="text-red-100 mb-8">Kontinuitet √§r grunden f√∂r ett h√•llbart s√§kerhetsarbete. H√§r beskrivs v√•ra fastst√§llda rutiner och krav p√• utbildning f√∂r all involverad personal.</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-white">√Öterkommande S√§kerhetsrutiner</h3>
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-lg shadow-sm border">
                                    <h4 class="font-semibold text-red-600">F√∂re Match</h4>
                                    <ul class="list-disc list-inside text-gray-700 mt-2">
                                        <li>S√§kerhetsgenomg√•ng med all personal</li>
                                        <li>Kontroll av utrymningsv√§gar och brandutrustning</li>
                                        <li>Arenabesiktning (skalskydd, sektioner)</li>
                                    </ul>
                                </div>
                                <div class="bg-white p-4 rounded-lg shadow-sm border">
                                    <h4 class="font-semibold text-red-600">Under Match</h4>
                                    <ul class="list-disc list-inside text-gray-700 mt-2">
                                        <li>Kontinuerlig √∂vervakning av publikfl√∂den</li>
                                        <li>Tydlig n√§rvaro av publikv√§rdar och vakter</li>
                                        <li>Rapportering av avvikelser till s√§kerhetsansvarig</li>
                                    </ul>
                                </div>
                                <div class="bg-white p-4 rounded-lg shadow-sm border">
                                    <h4 class="font-semibold text-red-600">Efter Match</h4>
                                    <ul class="list-disc list-inside text-gray-700 mt-2">
                                        <li>Kontrollerat utt√•g av publik</li>
                                        <li>Avrapportering och incidentdokumentation</li>
                                        <li>Snabb utv√§rdering av s√§kerhetsinsatsen</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-white">Utbildningskrav</h3>
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-lg shadow-sm border">
                                    <h4 class="font-semibold text-red-600">All S√§kerhetspersonal</h4>
                                    <p class="text-gray-700 mt-2">Obligatorisk √•rlig utbildning i HLR (Hj√§rt- och lungr√§ddning), f√∂rsta hj√§lpen och grundl√§ggande brandkunskap. Genomg√•ng av denna s√§kerhetsplan.</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg shadow-sm border">
                                    <h4 class="font-semibold text-red-600">Ordningsvakter & V√§rdar</h4>
                                    <p class="text-gray-700 mt-2">Specifik utbildning i konflikthantering, kommunikation och rutiner f√∂r visitation. Ordningsvakter ska ha giltigt f√∂rordnande.</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg shadow-sm border">
                                    <h4 class="font-semibold text-red-600">√ñvningar</h4>
                                    <p class="text-gray-700 mt-2">Minst en fullskalig utrymnings√∂vning per s√§song i samverkan med r√§ddningstj√§nst. Regelbundna teoretiska √∂vningar (table-top) baserade p√• olika scenarion.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Ljungby Arena Section -->
                <section id="arena" class="main-content hidden">
                    <h2 class="text-3xl font-bold mb-2">Ljungby Arena</h2>
                    <p class="text-red-100 mb-6">Ljungby Arena, tidigare k√§nd som Sunnerbohov, √§r IF Troja-Ljungbys hemmaarena. Den renoverades och byggdes ut 2015 f√∂r att m√∂ta moderna krav p√• kapacitet, s√§kerhet och service. Arenan √§r inte bara en plats f√∂r ishockey utan fungerar √§ven som en multifunktionell anl√§ggning f√∂r m√§ssor, konserter och andra evenemang.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <h3 class="font-semibold text-lg mb-2 text-red-600">Kapacitet</h3>
                            <p class="text-gray-700">Den totala kapaciteten f√∂r evenemang √§r **3 400** bes√∂kare. Detta inkluderar st√•platser och sittplatser.</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <h3 class="font-semibold text-lg mb-2 text-red-600">Byggnadens struktur</h3>
                            <p class="text-gray-700">Arenan best√•r av en A-hall och en B-hall samt konferensutrymmen, restaurang, cafeteria och pub. Det finns √§ven fem loger tillg√§ngliga.</p>
                        </div>
                    </div>
                </section>

                <!-- Scenario√∂vning Section -->
                <section id="scenario" class="main-content hidden">
                    <h2 class="text-3xl font-bold mb-2">Scenario√∂vning med AI ‚ú®</h2>
                    <p class="text-red-100 mb-6">Tr√§na p√• olika situationer genom att generera realistiska scenarier. Beskriv en h√§ndelse s√• skapar AI:n ett detaljerat h√§ndelsef√∂rlopp f√∂r din √∂vning.</p>
                    <div class="generator-box">
                        <h3 class="font-semibold text-xl mb-3">Generera ditt scenario</h3>
                        <textarea id="scenario-input" class="w-full h-24 p-2 rounded-lg bg-white bg-opacity-80 text-gray-700 mb-4" placeholder="Exempel: En person ramlar i trappan och √§r medvetsl√∂s, en mindre brand i en papperskorg p√• l√§ktaren, eller en mindre ordningsst√∂rning mellan tv√• supportrar."></textarea>
                        <div class="flex flex-col sm:flex-row gap-4 items-center">
                            <button id="generate-button" class="bg-[#FFD700] text-[#880000] font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-yellow-300 transition-colors">
                                Generera Scenario ‚ú®
                            </button>
                            <span id="loading-indicator" class="hidden text-white font-semibold">Genererar...</span>
                        </div>
                    </div>
                    <div id="scenario-output" class="bg-white p-6 rounded-xl shadow-sm border mt-6 hidden">
                        <h4 class="font-bold text-red-600 text-lg mb-2">Genererat Scenario:</h4>
                        <div id="scenario-text" class="text-gray-700"></div>
                    </div>
                </section>
                
                <!-- H√§ndelserapportgenerator Section -->
                <section id="rapport" class="main-content hidden">
                    <h2 class="text-3xl font-bold mb-2">H√§ndelserapportgenerator ‚ú®</h2>
                    <p class="text-red-100 mb-6">F√• hj√§lp med att snabbt dokumentera incidenter. Mata in dina anteckningar s√• skapar AI:n en strukturerad h√§ndelserapport √•t dig.</p>
                    <div class="generator-box">
                        <h3 class="font-semibold text-xl mb-3">Anteckningar fr√•n H√§ndelsen</h3>
                        <textarea id="report-input" class="w-full h-32 p-2 rounded-lg bg-white bg-opacity-80 text-gray-700 mb-4" placeholder="Exempel: Datum: 2025-08-31, Plats: Sektion B, kl. 19:45. H√§ndelse: Tv√• supportrar b√∂rjade br√•ka efter ett m√•l. √Ötg√§rd: Ordningsvakter ingrep, avvisade personerna. Polisen kontaktades. Skador: Inga."></textarea>
                        <div class="flex flex-col sm:flex-row gap-4 items-center">
                            <button id="generate-report-button" class="bg-[#FFD700] text-[#880000] font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-yellow-300 transition-colors">
                                Skapa Rapport ‚ú®
                            </button>
                            <span id="report-loading-indicator" class="hidden text-white font-semibold">Skapar rapport...</span>
                        </div>
                    </div>
                    <div id="report-output" class="bg-white p-6 rounded-xl shadow-sm border mt-6 hidden">
                        <h4 class="font-bold text-red-600 text-lg mb-2">Genererad H√§ndelserapport:</h4>
                        <div id="report-text" class="text-gray-700 prose max-w-none"></div>
                    </div>
                </section>

                <!-- Fr√•ga S√§kerhets-AI Chatbot Section -->
                <section id="chatbot" class="main-content hidden">
                    <h2 class="text-3xl font-bold mb-2">Fr√•ga S√§kerhets-AI ‚ú®</h2>
                    <p class="text-red-100 mb-6">St√§ll fr√•gor om s√§kerhetsplanen f√∂r att f√• snabba och korrekta svar. AI:n fungerar som en expert som √§r insatt i dokumentets inneh√•ll.</p>
                    <div class="generator-box p-6">
                        <div id="chat-container" class="chat-container mb-4">
                            <!-- Meddelanden l√§ggs till h√§r dynamiskt -->
                            <div class="ai-message">Hej! Hur kan jag hj√§lpa dig med s√§kerhetsplanen idag?</div>
                        </div>
                        <div class="flex">
                            <input type="text" id="chat-input" class="flex-1 p-2 rounded-l-lg bg-white bg-opacity-80 text-gray-700" placeholder="St√§ll din fr√•ga...">
                            <button id="send-chat-button" class="bg-[#FFD700] text-[#880000] font-semibold py-2 px-4 rounded-r-lg shadow-md hover:bg-yellow-300 transition-colors">
                                Skicka ‚ú®
                            </button>
                        </div>
                    </div>
                </section>


            </div>
        </main>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
            <div class="p-6 border-b sticky top-0 bg-white z-10">
                <h3 id="modal-title" class="text-2xl font-bold">Modal Title</h3>
                <button id="modal-close" class="absolute top-4 right-4 text-2xl text-slate-500 hover:text-slate-800">&times;</button>
            </div>
            <div id="modal-body" class="p-6">
                <p>Modal content goes here.</p>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const navLinks = document.querySelectorAll('#main-nav a');
            const contentSections = document.querySelectorAll('.main-content');
            const riskChartCtx = document.getElementById('riskChart')?.getContext('2d');

            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalClose = document.getElementById('modal-close');

            // API-relaterade konstanter
            const API_KEY = ""; // L√§mna tom, nyckeln tillhandah√•lls av milj√∂n.
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
            const GENERATE_BUTTON = document.getElementById('generate-button');
            const SCENARIO_INPUT = document.getElementById('scenario-input');
            const SCENARIO_OUTPUT = document.getElementById('scenario-output');
            const SCENARIO_TEXT = document.getElementById('scenario-text');
            const LOADING_INDICATOR = document.getElementById('loading-indicator');
            
            // Konstanter f√∂r den nya rapportgeneratorn
            const GENERATE_REPORT_BUTTON = document.getElementById('generate-report-button');
            const REPORT_INPUT = document.getElementById('report-input');
            const REPORT_OUTPUT = document.getElementById('report-output');
            const REPORT_TEXT = document.getElementById('report-text');
            const REPORT_LOADING_INDICATOR = document.getElementById('report-loading-indicator');

            // Konstanter f√∂r den nya chatbot-funktionen
            const CHAT_INPUT = document.getElementById('chat-input');
            const SEND_CHAT_BUTTON = document.getElementById('send-chat-button');
            const CHAT_CONTAINER = document.getElementById('chat-container');


            // H√•rdkodad data
            const riskData = {
                publik: [
                    { name: 'Slagsm√•l/br√•k', prob: 3, cons: 4, desc: 'F√∂rebyggs genom synlig personal, sektionering och nolltolerans mot aggressivt beteende.' },
                    { name: 'Pyroteknik', prob: 2, cons: 5, desc: 'F√∂rebyggs genom visitation vid inpassering och tydlig kommunikation om f√∂rbud.' },
                    { name: 'Berusning', prob: 4, cons: 3, desc: 'Nekat intr√§de f√∂r uppenbart p√•verkade personer. Ordningsvakter hanterar avvisning.' },
                    { name: 'Inkastade f√∂rem√•l', prob: 3, cons: 3, desc: 'N√§t bakom m√•l och uppmaningar fr√•n speaker. Kan leda till matchstraff.' }
                ],
                arena: [
                    { name: 'Str√∂mavbrott', prob: 1, cons: 4, desc: 'Reservbelysning f√∂r utrymningsv√§gar. Plan f√∂r kontrollerad utrymning vid l√•ngvarigt avbrott.' },
                    { name: 'Halkrisk', prob: 4, cons: 2, desc: 'Regelbunden sandning/saltning utanf√∂r. Varningsskyltar och avtorkning vid entr√©er.' },
                    { name: 'Brand', prob: 1, cons: 5, desc: 'Automatiskt brandlarm, tydliga utrymningsv√§gar, utbildad personal och brandsl√§ckare.' }
                ],
                spel: [
                    { name: 'Allvarlig spelarskada', prob: 3, cons: 4, desc: 'Medicinskt team p√• plats med b√•r och akututrustning. Tydlig rutin f√∂r att snabbt assistera p√• isen.' },
                    { name: 'Spill p√• isen', prob: 2, cons: 2, desc: 'Isv√•rdspersonal i beredskap f√∂r att snabbt √•tg√§rda problem och s√§kerst√§lla spelets forts√§ttning.' }
                ]
            };

            const roleDetails = {
                sakerhetsansvarig: { title: 'S√§kerhetsansvarig', content: '<ul><li class="mb-2"><strong>√ñvergripande Ansvar:</strong> Leda, planera och utv√§rdera allt s√§kerhetsarbete.</li><li class="mb-2"><strong>Beslutsfattare:</strong> H√∂gsta beslutande i s√§kerhetsfr√•gor under evenemang.</li><li class="mb-2"><strong>Kontaktperson:</strong> Huvudkontakt mot polis, r√§ddningstj√§nst och f√∂rbund.</li><li class="mb-2"><strong>Dokumentation:</strong> Ansvarar f√∂r att s√§kerhetsplanen √§r uppdaterad och att incidenter rapporteras korrekt.</li></ul>' },
                ordningsvakter: { title: 'Ordningsvakter', content: '<ul><li class="mb-2"><strong>Uppr√§tth√•lla Ordning:</strong> Ingripa vid ordningsst√∂rningar, avvisa/avl√§gsna personer enligt PL¬ß13.</li><li class="mb-2"><strong>Visitation:</strong> Genomf√∂ra visitation vid entr√©er f√∂r att f√∂rhindra otill√•tna f√∂rem√•l.</li><li class="mb-2"><strong>Myndighetskontakt:</strong> St√• i direktkontakt med polis vid behov av f√∂rst√§rkning.</li></ul>' },
                sjukvard: { title: 'Sjukv√•rdsansvarig', content: '<ul><li class="mb-2"><strong>F√∂rsta Insats:</strong> Leda sjukv√•rdsinsatsen vid skada eller akut sjukdomsfall.</li><li class="mb-2"><strong>Utrustning:</strong> S√§kerst√§lla att sjukv√•rdsutrustning (HLR-kit, b√•r, etc.) finns och √§r funktionell.</li><li class="mb-2"><strong>Larm:</strong> Ansvara f√∂r att larma 112 och ge en tydlig rapport till anl√§ndande ambulanspersonal.</li></ul>' },
                brandskydd: { title: 'Brandskyddsansvarig', content: '<ul><li class="mb-2"><strong>F√∂rebyggande:</strong> Kontrollera utrymningsv√§gar, brandlarm och sl√§ckutrustning inf√∂r varje evenemang.</li><li class="mb-2"><strong>Vid Larm:</strong> Leda utrymningsarbetet och v√§gleda r√§ddningstj√§nsten vid ankomst.</li><li class="mb-2"><strong>Kunskap:</strong> Ha detaljerad kunskap om arenans brandskyddssystem.</li></ul>' },
                publikvardar: { title: 'Publikv√§rdar', content: '<ul><li class="mb-2"><strong>Service & Information:</strong> Vara klubbens ansikte ut√•t. Svara p√• fr√•gor, h√§nvisa och hj√§lpa publiken.</li><li class="mb-2"><strong>Observation:</strong> Agera som "√∂gon och √∂ron" och rapportera avvikelser och potentiella problem till s√§kerhetsansvarig eller ordningsvakt.</li><li class="mb-2"><strong>Utrymning:</strong> Assistera vid en utrymning genom att v√§gleda publiken till n√§rmaste utg√•ng.</li></ul>' }
            };

            const actionDetails = {
                brand: { title: '√Ötg√§rdsplan: Brand', content: '<ol class="list-decimal list-inside space-y-2"><li><strong>R√ÑDDA:</strong> Den som uppt√§cker branden ska varna andra i omedelbar n√§rhet och hj√§lpa dem i s√§kerhet.</li><li><strong>LARMA:</strong> Aktivera n√§rmaste brandlarm. Ring 112 och meddela s√§kerhetsansvarig via intern radio.</li><li><strong>SL√ÑCK:</strong> Om det √§r en mindre brand och du √§r tr√§nad, f√∂rs√∂k sl√§cka med n√§rmaste brandsl√§ckare. Uts√§tt dig inte f√∂r fara.</li><li><strong>UTRYM:</strong> Personal v√§gleder publiken till anvisade utrymningsv√§gar och samlingsplatser. St√§ng d√∂rrar efter dig.</li></ol>' },
                sjukdom: { title: '√Ötg√§rdsplan: Akut Sjukdom/Skada', content: '<ol class="list-decimal list-inside space-y-2"><li><strong>SKAPA FRI YTA:</strong> Be n√§rst√•ende att backa undan f√∂r att ge patienten och personalen utrymme.</li><li><strong>LARMA INTERNT:</strong> Kontakta sjukv√•rdsansvarig omedelbart via radio. Ange plats och typ av skada/symptom.</li><li><strong>F√ñRSTA HJ√ÑLPEN:</strong> Sjukv√•rdspersonal p√•b√∂rjar HLR eller annan f√∂rsta hj√§lpen.</li><li><strong>LARMA 112:</strong> Sjukv√•rdsansvarig ringer 112 och f√∂rbereder f√∂r ambulansens ankomst.</li><li><strong>V√ÑGLED AMBULANS:</strong> En person m√∂ter upp ambulansen och visar snabbaste v√§gen till patienten.</li></ol>' },
                ordningsstorning: { title: '√Ötg√§rdsplan: Ordningsst√∂rning', content: '<ol class="list-decimal list-inside space-y-2"><li><strong>Observera & Rapportera:</strong> Publikv√§rd rapporterar incidenten till ordningsvakt och s√§kerhetsansvarig.</li><li><strong>Isolera:</strong> Ordningsvakter g√•r fram och isolerar de inblandade f√∂r att f√∂rhindra eskalering.</li><li><strong>Kommunicera:</strong> F√∂rs√∂k lugna situationen med ett l√•gaffektivt bem√∂tande.</li><li><strong>√Ötg√§rd:</strong> Beroende p√• situationens allvar, avvisa (person ombeds l√§mna) eller avl√§gsna (person f√∂rs ut fysiskt) personen/personerna. Vid v√•ld eller hot tillkallas polis.</li><li><strong>Dokumentera:</strong> Alla ingripanden dokumenteras efter√•t.</li></ol>' },
                utrymning: { title: '√Ötg√§rdsplan: Utrymning', content: '<ol class="list-decimal list-inside space-y-2"><li><strong>Beslut:</strong> Beslut om utrymning tas av s√§kerhetsansvarig (eller r√§ddningsledare).</li><li><strong>Kommunikation:</strong> Meddelande om utrymning g√•r ut via h√∂gtalarsystemet. Lugn och tydlig information.</li><li><strong>V√§gledning:</strong> All personal agerar v√§gvisare. Publikv√§rdar och vakter dirigerar publiken mot n√§rmaste n√∂dutg√•ng.</li><li><strong>Kontroll:</strong> Personal s√∂ker igenom sina ansvarsomr√•den (t.ex. toaletter) f√∂r att s√§kerst√§lla att ingen √§r kvar.</li><li><strong>Samlingsplats:</strong> Publiken h√§nvisas till den officiella samlingsplatsen.</li><li><strong>Avrapportering:</strong> Sektorsansvariga rapporterar till s√§kerhetsansvarig n√§r deras omr√•de √§r tomt.</li></ol>' },
                hot: { title: '√Ötg√§rdsplan: Allvarligt Hot', content: '<ol class="list-decimal list-inside space-y-2"><li><strong>Ta alla hot p√• allvar.</strong></li><li><strong>Larma Polis:</strong> Ring 112 omedelbart. Informera s√§kerhetsansvarig.</li><li><strong>Avsp√§rrning:</strong> Om hotet √§r riktat mot ett specifikt omr√•de, sp√§rra av det diskret om m√∂jligt.</li><li><strong>F√∂lj Polisens direktiv:</strong> Polisen leder insatsen. Alla beslut om t.ex. utrymning tas i samr√•d med eller av polisen.</li><li><strong>Intern Kommunikation:</strong> H√•ll intern kommunikation diskret f√∂r att inte skapa panik.</li></ol>' },
                pyroteknik: { title: '√Ötg√§rdsplan: Pyroteknik', content: '<ol class="list-decimal list-inside space-y-2"><li><strong>Identifiera Plats:</strong> Personal f√∂rs√∂ker omedelbart identifiera var pj√§sen br√§ndes av.</li><li><strong>Dokumentera:</strong> Fotografera eller filma g√§rningspersonen om m√∂jligt utan att uts√§tta sig f√∂r risk.</li><li><strong>Informera Speaker:</strong> Speaker meddelar att anv√§ndning av pyroteknik √§r olagligt och farligt och kan leda till att matchen avbryts.</li><li><strong>Ingripande:</strong> Ordningsvakter ingriper f√∂r att omh√§nderta personen/personerna n√§r det √§r s√§kert att g√∂ra det.</li><li><strong>Rapportera:</strong> H√§ndelsen rapporteras alltid till polisen och i matchprotokollet.</li></ol>' }
            };
            
            // Textinneh√•ll fr√•n de olika sektionerna, skickas som kontext till LLM
            const planTextContent = `
                S√§kerhetsplan f√∂r Troja Ljungby.
                Syfte: Skapa en trygg milj√∂, fri fr√•n v√•ld och hot.
                Ansvar: S√§kerhetsansvarig har det √∂vergripande ansvaret.
                Grundprinciper: Proaktivitet, tydlig ansvarsf√∂rdelning, samverkan med myndigheter, kontinuerlig utv√§rdering.

                Riskanalys:
                Publikrelaterade risker: Slagsm√•l/br√•k, pyroteknik, berusning, inkastade f√∂rem√•l.
                Arenarelaterade risker: Str√∂mavbrott, halkrisk, brand.
                Spelrelaterade risker: Allvarlig spelarskada, spill p√• isen.

                Organisation och Roller:
                S√§kerhetsansvarig: Ledar allt s√§kerhetsarbete, beslutsfattare, kontaktperson f√∂r myndigheter.
                Ordningsvakter: Uppr√§tth√•ller ordning, visitation, ingriper vid st√∂rningar.
                Sjukv√•rdsansvarig: Ledar sjukv√•rdsinsats, utrustning, larmar 112.
                Brandskyddsansvarig: Kontrollerar utrymning, leder utrymning vid brand.
                Publikv√§rdar: Ger service, observerar avvikelser, assisterar vid utrymning.

                √Ötg√§rdsplaner vid Incident:
                Brand: R√§dda, larma (112, intern radio), sl√§ck (om s√§kert), utrym, samlingsplats.
                Akut Sjukdom/Skada: Skapa fri yta, larma internt, ge f√∂rsta hj√§lpen, larma 112, v√§gled ambulans.
                Ordningsst√∂rning: Observera/rapportera, isolera, kommunicera lugnande, avvisa/avl√§gsna, dokumentera.
                Utrymning: Beslut tas av s√§kerhetsansvarig. Meddelande via h√∂gtalare, personal v√§gleder, kontroll av omr√•den, samlingsplats.
                Allvarligt Hot: Ta hot p√• allvar, larma polis (112), f√∂lj polisens direktiv.
                Pyroteknik: Identifiera plats, dokumentera g√§rningsperson, informera speaker, ingrip, rapportera till polis.

                Rutiner och Utbildning:
                F√∂re Match: S√§kerhetsgenomg√•ng, kontroll av utrymningsv√§gar, arenabesiktning.
                Under Match: Kontinuerlig √∂vervakning, tydlig personaln√§rvaro, rapportering av avvikelser.
                Efter Match: Kontrollerat utt√•g, avrapportering, utv√§rdering.
                Utbildningskrav: √Örlig HLR, f√∂rsta hj√§lpen, brandkunskap. Specifik utbildning i konflikthantering f√∂r vakter.
            `;

            // Funktion f√∂r att visa sektioner
            function showSection(hash) {
                const targetId = hash.substring(1);
                contentSections.forEach(section => {
                    if (section.id === targetId) {
                        section.classList.remove('hidden');
                    } else {
                        section.classList.add('hidden');
                    }
                });
                navLinks.forEach(link => {
                    if (link.getAttribute('href') === hash) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });
            }

            // Funktioner f√∂r modal
            function openModal(title, content) {
                modalTitle.textContent = title;
                modalBody.innerHTML = content;
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            function closeModal() {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }

            // H√§ndelselyssnare f√∂r navigering
            navLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const hash = this.getAttribute('href');
                    history.pushState(null, null, hash);
                    showSection(hash);
                });
            });

            window.addEventListener('popstate', () => {
                showSection(window.location.hash || '#oversikt');
            });

            showSection(window.location.hash || '#oversikt');

            // H√§ndelselyssnare f√∂r modal
            modalClose.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // H√§ndelselyssnare f√∂r rollkort
            document.querySelectorAll('.role-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const roleId = e.currentTarget.dataset.role;
                    const details = roleDetails[roleId];
                    if (details) {
                        openModal(details.title, details.content);
                    }
                });
            });

            // H√§ndelselyssnare f√∂r √•tg√§rdskort
            document.querySelectorAll('.action-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const actionId = e.currentTarget.dataset.action;
                    const details = actionDetails[actionId];
                    if (details) {
                        openModal(details.title, details.content);
                    }
                });
            });

            // Funktion f√∂r att rendera riskdetaljer baserat p√• filter
            function renderRiskDetails(filter = 'all') {
                const container = document.getElementById('risk-details');
                container.innerHTML = '';

                const risksToShow = (filter === 'all')
                    ? [...riskData.publik, ...riskData.arena, ...riskData.spel]
                    : riskData[filter];

                if (!risksToShow) return;

                risksToShow.forEach(risk => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow-sm border border-slate-200';
                    card.innerHTML = `<h4 class="font-semibold text-red-600">${risk.name}</h4><p class="text-gray-700">${risk.desc}</p>`;
                    container.appendChild(card);
                });
            }

            // H√§ndelselyssnare f√∂r riskfilterknappar
            document.querySelectorAll('.risk-filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                     document.querySelectorAll('.risk-filter-btn').forEach(b => {
                        b.classList.remove('bg-[#FFD700]', 'text-[#880000]');
                        b.classList.add('bg-white');
                    });
                    e.currentTarget.classList.add('bg-[#FFD700]', 'text-[#880000]');
                    e.currentTarget.classList.remove('bg-white');

                    const riskCategory = e.currentTarget.dataset.risk;
                    renderRiskDetails(riskCategory);
                });
            });

            // Initiering av riskdiagram
            if (riskChartCtx) {
                const allRisks = [...riskData.publik, ...riskData.arena, ...riskData.spel];
                new Chart(riskChartCtx, {
                    type: 'bubble',
                    data: {
                        datasets: [{
                            label: 'Publikrelaterat',
                            data: riskData.publik.map(r => ({ x: r.prob, y: r.cons, r: 15, name: r.name })),
                            backgroundColor: 'rgba(220, 20, 60, 0.7)' /* Red */
                        }, {
                            label: 'Arenarelaterat',
                            data: riskData.arena.map(r => ({ x: r.prob, y: r.cons, r: 15, name: r.name })),
                            backgroundColor: 'rgba(255, 69, 0, 0.7)' /* Orange-Red */
                        }, {
                            label: 'Spelrelaterat',
                            data: riskData.spel.map(r => ({ x: r.prob, y: r.cons, r: 15, name: r.name })),
                            backgroundColor: 'rgba(255, 140, 0, 0.7)' /* Dark Orange */
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top', labels: { color: 'black' } },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const data = context.dataset.data[context.dataIndex];
                                        return `${data.name}: Sannolikhet ${data.x}, Konsekvens ${data.y}`;
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Riskmatris: Sannolikhet vs. Konsekvens',
                                color: 'black'
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Sannolikhet (1-5)', color: 'black' },
                                min: 0, max: 5.5,
                                grid: { color: 'rgba(0,0,0,0.2)' },
                                ticks: { color: 'black' }
                            },
                            y: {
                                title: { display: true, text: 'Konsekvens (1-5)', color: 'black' },
                                min: 0, max: 5.5,
                                grid: { color: 'rgba(0,0,0,0.2)' },
                                ticks: { color: 'black' }
                            }
                        }
                    }
                });
            }

            renderRiskDetails();


            // Funktion f√∂r API-anrop med retry-logik
            async function callGeminiApi(userPrompt, systemPrompt) {
                let retries = 0;
                const maxRetries = 3;
                const initialDelay = 1000;

                const payload = {
                    contents: [{
                        parts: [{
                            text: userPrompt
                        }]
                    }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    tools: [{ "google_search": {} }]
                };

                async function fetchWithRetry() {
                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            if (response.status === 429 && retries < maxRetries) {
                                const delay = initialDelay * Math.pow(2, retries);
                                retries++;
                                await new Promise(resolve => setTimeout(resolve, delay));
                                return fetchWithRetry();
                            }
                            throw new Error(`API-anrop misslyckades: ${response.statusText}`);
                        }

                        const result = await response.json();
                        const candidate = result?.candidates?.[0];

                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            return candidate.content.parts[0].text;
                        } else {
                            throw new Error('Kunde inte generera inneh√•ll fr√•n API:n.');
                        }
                    } catch (error) {
                        throw error;
                    }
                }
                return fetchWithRetry();
            }

            // Gemini API-integration f√∂r Scenario√∂vning
            GENERATE_BUTTON.addEventListener('click', async () => {
                const userPrompt = SCENARIO_INPUT.value.trim();
                if (!userPrompt) {
                    SCENARIO_TEXT.textContent = 'V√§nligen ange ett scenario att generera.';
                    return;
                }

                SCENARIO_TEXT.textContent = '';
                SCENARIO_OUTPUT.classList.add('hidden');
                LOADING_INDICATOR.classList.remove('hidden');

                const systemPrompt = "Generera ett detaljerat och realistiskt scenario f√∂r en s√§kerhets√∂vning p√• en ishockeyarena. Scenariot ska inneh√•lla en tydlig h√§ndelsebeskrivning, vilka omedelbara √•tg√§rder som ska vidtas och en kort utv√§rdering av potentiella konsekvenser. Skriv svaret som ren text.";
                const finalUserPrompt = `Generera ett scenario baserat p√• f√∂ljande h√§ndelse: "${userPrompt}"`;

                try {
                    const generatedText = await callGeminiApi(finalUserPrompt, systemPrompt);
                    SCENARIO_TEXT.innerHTML = generatedText.replace(/\n/g, '<br>');
                } catch (error) {
                    console.error('Fel vid anrop av Gemini API:', error);
                    SCENARIO_TEXT.textContent = 'Ett ov√§ntat fel uppstod. Kontrollera din internetanslutning eller f√∂rs√∂k igen senare.';
                } finally {
                    LOADING_INDICATOR.classList.add('hidden');
                    SCENARIO_OUTPUT.classList.remove('hidden');
                }
            });

            // Ny Gemini API-integration f√∂r H√§ndelserapportgenerator
            GENERATE_REPORT_BUTTON.addEventListener('click', async () => {
                const userNotes = REPORT_INPUT.value.trim();
                if (!userNotes) {
                    REPORT_TEXT.textContent = 'V√§nligen skriv in anteckningar om h√§ndelsen.';
                    return;
                }

                REPORT_TEXT.textContent = '';
                REPORT_OUTPUT.classList.add('hidden');
                REPORT_LOADING_INDICATOR.classList.remove('hidden');

                const systemPrompt = "Du √§r en professionell s√§kerhetsansvarig. Din uppgift √§r att omvandla en upps√§ttning anteckningar till en formell och professionell h√§ndelserapport. Rapporten ska vara strukturerad med f√∂ljande rubriker: H√§ndelseinformation, H√§ndelsef√∂rlopp, √Ötg√§rder, och Slutsatser/L√§rdomar. Anv√§nd rubriker (t.ex. '##') f√∂r att formatera rapporten tydligt.";
                const finalUserPrompt = `Skapa en formell h√§ndelserapport baserad p√• f√∂ljande anteckningar: "${userNotes}"`;

                try {
                    const generatedText = await callGeminiApi(finalUserPrompt, systemPrompt);
                    REPORT_TEXT.innerHTML = generatedText.replace(/### (.*)/g, '<h4 class="font-bold text-red-600 text-lg mb-2">$1</h4>').replace(/\n/g, '<br>');
                } catch (error) {
                    console.error('Fel vid anrop av Gemini API:', error);
                    REPORT_TEXT.textContent = 'Ett ov√§ntat fel uppstod. Kontrollera din internetanslutning eller f√∂rs√∂k igen senare.';
                } finally {
                    REPORT_LOADING_INDICATOR.classList.add('hidden');
                    REPORT_OUTPUT.classList.remove('hidden');
                }
            });

            // Ny Gemini API-integration f√∂r Chatbot
            SEND_CHAT_BUTTON.addEventListener('click', async () => {
                const userQuestion = CHAT_INPUT.value.trim();
                if (!userQuestion) return;

                appendMessage(userQuestion, 'user-message');
                CHAT_INPUT.value = '';

                // Skapa en meddelanderuta f√∂r AI-svar och en laddningsindikator
                const aiMessageDiv = appendMessage('...', 'ai-message');
                const chatLoadingDiv = document.createElement('div');
                chatLoadingDiv.className = 'ai-message text-sm text-gray-400 italic';
                chatLoadingDiv.textContent = 'AI funderar...';
                CHAT_CONTAINER.appendChild(chatLoadingDiv);
                CHAT_CONTAINER.scrollTop = CHAT_CONTAINER.scrollHeight;


                // Gemini API-anrop med systemkontext
                const systemPrompt = `Du √§r en expert p√• s√§kerhetsplanen f√∂r Troja Ljungby. Du har tillg√•ng till f√∂ljande information:\n\n${planTextContent}\n\nAnv√§nd denna information f√∂r att svara p√• anv√§ndarens fr√•gor. Var kortfattad och direkt. Om en fr√•ga inte kan besvaras med hj√§lp av den givna informationen, s√§g att du inte har den informationen men kan h√§nvisa till ansvarig s√§kerhetspersonal.`;

                try {
                    const generatedText = await callGeminiApi(userQuestion, systemPrompt);
                    aiMessageDiv.innerHTML = generatedText.replace(/\n/g, '<br>');
                } catch (error) {
                    console.error('Fel vid anrop av Gemini API:', error);
                    aiMessageDiv.textContent = 'Ett fel uppstod. Jag kan inte svara just nu.';
                } finally {
                    CHAT_CONTAINER.removeChild(chatLoadingDiv);
                    CHAT_CONTAINER.scrollTop = CHAT_CONTAINER.scrollHeight;
                }
            });

            // Funktion f√∂r att l√§gga till meddelanden i chattf√∂nstret
            function appendMessage(text, className) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${className}`;
                messageDiv.textContent = text;
                CHAT_CONTAINER.appendChild(messageDiv);
                CHAT_CONTAINER.scrollTop = CHAT_CONTAINER.scrollHeight;
                return messageDiv;
            }

            // G√∂r att man kan skicka meddelanden genom att trycka enter
            CHAT_INPUT.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    SEND_CHAT_BUTTON.click();
                }
            });
        });
    </script>
</body>
</html>
